<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Oxford_102_Flower_Tiny_DDPM</title>
<link>https://your-website-url.example.com/</link>
<atom:link href="https://your-website-url.example.com/index.xml" rel="self" type="application/rss+xml"/>
<description>A blog built with Quarto</description>
<generator>quarto-1.8.26</generator>
<lastBuildDate>Thu, 08 Jan 2026 15:00:00 GMT</lastBuildDate>
<item>
  <title>Post With Code</title>
  <dc:creator>Harlow Malloc</dc:creator>
  <link>https://your-website-url.example.com/posts/post-with-code/</link>
  <description><![CDATA[ 





<p>This is a post with executable code.</p>



 ]]></description>
  <category>news</category>
  <category>code</category>
  <category>analysis</category>
  <guid>https://your-website-url.example.com/posts/post-with-code/</guid>
  <pubDate>Thu, 08 Jan 2026 15:00:00 GMT</pubDate>
  <media:content url="https://your-website-url.example.com/posts/post-with-code/image.jpg" medium="image" type="image/jpeg"/>
</item>
<item>
  <title>Welcome To My Blog</title>
  <dc:creator>Tristan O&#39;Malley</dc:creator>
  <link>https://your-website-url.example.com/posts/welcome/</link>
  <description><![CDATA[ 





<p>This is the first post in a Quarto blog. Welcome!</p>
<p><img src="https://your-website-url.example.com/posts/welcome/thumbnail.jpg" class="img-fluid"></p>
<p>Since this post doesn’t specify an explicit <code>image</code>, the first image in the post will be used in the listing page of posts.</p>



 ]]></description>
  <category>news</category>
  <guid>https://your-website-url.example.com/posts/welcome/</guid>
  <pubDate>Mon, 05 Jan 2026 15:00:00 GMT</pubDate>
</item>
<item>
  <title>Load Dataset</title>
  <link>https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM.html</link>
  <description><![CDATA[ 





<div id="cell-2" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722955931,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:9628,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-execution_count="3">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> nn</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torchvision</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torchvision.transforms <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> transforms</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torchvision.utils <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> make_grid, save_image</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.utils.data <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> DataLoader, ConcatDataset</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math</span>
<span id="cb1-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span></code></pre></div></div>
</div>
<div id="cell-3" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;colab&quot;,&quot;value&quot;:{&quot;base_uri&quot;:&quot;https://localhost:8080/&quot;}}" data-outputid="19408190-7550-4b27-97df-5068f669f8cc" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. 전처리 미리 정의</span></span>
<span id="cb2-2">IMG_RES <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>)</span>
<span id="cb2-3">BATCH_SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb2-4"></span>
<span id="cb2-5">transform <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> transforms.Compose([</span>
<span id="cb2-6">    transforms.Resize(IMG_RES),</span>
<span id="cb2-7">    transforms.ToTensor(), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1) [0.0, 1.0] 실수 범위로 압축, 2) (H, W, C) -&gt; (C, H, W)</span></span>
<span id="cb2-8">    transforms.Normalize((<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>), (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 각각의 RGB 채널 평균 0.5, 표준편차 0.5로 Norm</span></span>
<span id="cb2-9">])</span>
<span id="cb2-10"></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. Load train/validation/test datasets</span></span>
<span id="cb2-12">train_set <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torchvision.datasets.Flowers102(root<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./data'</span>, split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'train'</span>, download<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, transform<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>transform)</span>
<span id="cb2-13">val_set <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torchvision.datasets.Flowers102(root<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./data'</span>, split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'val'</span>, download<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, transform<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>transform)</span>
<span id="cb2-14">test_set <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torchvision.datasets.Flowers102(root<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'./data'</span>, split<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'test'</span>, download<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, transform<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>transform)</span>
<span id="cb2-15"></span>
<span id="cb2-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3. 데이터셋 3종류 하나로 합치기(validation, test 불필요)</span></span>
<span id="cb2-17">dataset <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ConcatDataset([train_set, val_set, test_set])</span>
<span id="cb2-18"></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 4. 필요없는 변수 삭제 -&gt; 메모리 절약</span></span>
<span id="cb2-20"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">del</span> train_set, val_set, test_set</span>
<span id="cb2-21"></span>
<span id="cb2-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 5. dataloader</span></span>
<span id="cb2-23">dataloader <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DataLoader(</span>
<span id="cb2-24">    dataset,</span>
<span id="cb2-25">    batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>BATCH_SIZE, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 64개씩 batch 만들기</span></span>
<span id="cb2-26">    shuffle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 섞기</span></span>
<span id="cb2-27">    num_workers<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb2-28">    drop_last<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 자투리 버리기</span></span>
<span id="cb2-29">    pin_memory<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb2-30">)</span></code></pre></div></div>
<div class="cell-output cell-output-stderr">
<pre><code>100%|██████████| 345M/345M [00:09&lt;00:00, 37.0MB/s]
100%|██████████| 502/502 [00:00&lt;00:00, 2.14MB/s]
100%|██████████| 15.0k/15.0k [00:00&lt;00:00, 40.6MB/s]</code></pre>
</div>
</div>
<div id="cell-4" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722975609,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:562,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-outputid="c7326131-6596-4907-cccb-a49002e39ec5" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shape 확인</span></span>
<span id="cb4-2">iterForShapeCheck <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">iter</span>(dataloader)</span>
<span id="cb4-3">oneBatchTensorForShapeCheck <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(iterForShapeCheck)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb4-4"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Shape of One Batch: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>oneBatchTensorForShapeCheck<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Shape of One Batch: torch.Size([64, 3, 64, 64])</code></pre>
</div>
</div>
<div id="cell-5" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722976438,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:828,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-outputid="8a3e8005-3821-4f98-8f32-8521a0889bf8" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 10개만 시각화해서 확인</span></span>
<span id="cb6-2"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 1) batch 하나 준비</span></span>
<span id="cb6-3">dataIterator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">iter</span>(dataloader) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># dataloader은 iterable 하지만 iterator는 아님 -&gt; iterator로 만들어주기</span></span>
<span id="cb6-4">images, labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(dataIterator) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># images, labels에 batch 하나가 담김</span></span>
<span id="cb6-5"></span>
<span id="cb6-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 2) 도화지 정의</span></span>
<span id="cb6-7">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fig: 전체 도화지, axes: 각각의 칸(numpy array)</span></span>
<span id="cb6-8">plt.subplots_adjust(wspace<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 이미지 사이 간격</span></span>
<span id="cb6-9"></span>
<span id="cb6-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 3) 그림 그리기</span></span>
<span id="cb6-11"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>):</span>
<span id="cb6-12">  img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> images[i]</span>
<span id="cb6-13">  img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normalize 했던거 원래대로 복구</span></span>
<span id="cb6-14">  img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> img.permute(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (C, H, W) -&gt; (H, W, C)</span></span>
<span id="cb6-15">  axes[i].imshow(img.cpu().numpy()) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># numpy(): Tensor -&gt; Numpy Array</span></span>
<span id="cb6-16">  axes[i].axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 눈금제거</span></span>
<span id="cb6-17"></span>
<span id="cb6-18">plt.suptitle(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"10 Images from Oxford 102 Flowers"</span>, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>)</span>
<span id="cb6-19">plt.show()</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="diffusion-schedule-forward-process" class="level2">
<h2 class="anchored" data-anchor-id="diffusion-schedule-forward-process">Diffusion Schedule (Forward Process)</h2>
<div id="cell-7" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722976443,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:3,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3가지 diffusion schedules - Linear/Cosine/Offset Cosine</span></span>
<span id="cb7-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> DiffusionSchedules:</span>
<span id="cb7-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>):</span>
<span id="cb7-4">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T</span>
<span id="cb7-5">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, T) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># [0.000, 0.001, 0.002, ... 0.999, 1.000]</span></span>
<span id="cb7-6"></span>
<span id="cb7-7">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 1) Linear Diffusion Schedules</span></span>
<span id="cb7-8">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">### t 지나면서 beta가 linear 하게 커짐</span></span>
<span id="cb7-9">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> linear_diffusion_schedule(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb7-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## beta 범위 설정</span></span>
<span id="cb7-11">    min_beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0001</span></span>
<span id="cb7-12">    max_beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span></span>
<span id="cb7-13"></span>
<span id="cb7-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># betas, alphas, alpha_bars</span></span>
<span id="cb7-15">    betas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> min_beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (max_beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> min_beta)</span>
<span id="cb7-16">    alphas <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> betas</span>
<span id="cb7-17">    alpha_bars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cumprod(alphas, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># coumprod: 누적 곱셈 [2, 3, 5] -&gt; [2, 6, 30]</span></span>
<span id="cb7-18"></span>
<span id="cb7-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># noise, blur rates(tensor)</span></span>
<span id="cb7-20">    noise_rates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha_bars)</span>
<span id="cb7-21">    blur_rates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sqrt(alpha_bars)</span>
<span id="cb7-22"></span>
<span id="cb7-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> blur_rates, noise_rates <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 앞에 곱하는걸 앞에 썼음.</span></span>
<span id="cb7-24"></span>
<span id="cb7-25"></span>
<span id="cb7-26">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 2) Cosine Diffusion Schedules</span></span>
<span id="cb7-27">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">### sin^2 + cos^2 = 1 이용한 schedule</span></span>
<span id="cb7-28">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> cosine_diffusion_schedule(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb7-29">    blur_rates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cos(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> math.pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-30">    noise_rates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sin(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> math.pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-31"></span>
<span id="cb7-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> blur_rates, noise_rates</span>
<span id="cb7-33"></span>
<span id="cb7-34"></span>
<span id="cb7-35">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 3) Offset Cosine Schedules</span></span>
<span id="cb7-36">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">### 너무 어둡거나 밝은 이미지 생성 방지</span></span>
<span id="cb7-37">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> offset_diffusion_schedule(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>):</span>
<span id="cb7-38">    min_blur_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span></span>
<span id="cb7-39">    max_blur_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.999</span></span>
<span id="cb7-40"></span>
<span id="cb7-41">    max_blur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(max_blur_rate).clamp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)</span>
<span id="cb7-42">    min_blur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(min_blur_rate).clamp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>)</span>
<span id="cb7-43"></span>
<span id="cb7-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># min, max의 cos 각도</span></span>
<span id="cb7-45">    start_angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.acos(max_blur)</span>
<span id="cb7-46">    end_angle   <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.acos(min_blur)</span>
<span id="cb7-47"></span>
<span id="cb7-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 각도를 linear하게 세팅해서 sin, cos 사용</span></span>
<span id="cb7-49">    diffusion_angles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> start_angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (end_angle <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> start_angle)</span>
<span id="cb7-50">    blur_rates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cos(diffusion_angles)</span>
<span id="cb7-51">    noise_rates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sin(diffusion_angles)</span>
<span id="cb7-52"></span>
<span id="cb7-53">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> blur_rates, noise_rates</span></code></pre></div></div>
</div>
<section id="schedules-visualizations" class="level3">
<h3 class="anchored" data-anchor-id="schedules-visualizations">Schedules Visualizations</h3>
<div id="cell-9" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722976446,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:1,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-execution_count="8">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Schedule별 blur_rates, noise_rates 시각화</span></span>
<span id="cb8-2">schedules <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionSchedules(T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Schdule들 모아놓은 class 호출</span></span>
<span id="cb8-3">linear_blurs, linear_noises <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> schedules.linear_diffusion_schedule()</span>
<span id="cb8-4">cosine_blurs, cosine_noises <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> schedules.cosine_diffusion_schedule()</span>
<span id="cb8-5">offset_blurs, offset_noises <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> schedules.offset_diffusion_schedule()</span>
<span id="cb8-6">diffusion_times <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> schedules.times</span></code></pre></div></div>
</div>
<div id="cell-10" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722976651,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:204,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-outputid="445215a6-96ef-4837-fe50-cc117627e788" data-execution_count="9">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1. blurs: alpha_t bar</span></span>
<span id="cb9-2">plt.plot(diffusion_times, linear_blurs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#990099"</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"linear Schedule"</span>)</span>
<span id="cb9-3">plt.plot(diffusion_times, cosine_blurs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#3b3eac"</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cosine Schedule"</span>)</span>
<span id="cb9-4">plt.plot(diffusion_times, offset_blurs<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"#329262"</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Offset Cosine Schedule"</span>)</span>
<span id="cb9-5"></span>
<span id="cb9-6">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t / T"</span>)</span>
<span id="cb9-7">plt.ylabel(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$\b</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">ar{</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\a</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">lpha_t}</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">Blur</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb9-8">plt.legend()</span>
<span id="cb9-9">plt.show()</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-8-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="cell-11" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722976777,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:125,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-outputid="53f23fa5-261f-4fc6-9523-92ea60320f11" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#2. noises: 1 - alpha_t bar</span></span>
<span id="cb10-2">plt.plot(diffusion_times, linear_noises<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"linear Schedule"</span>)</span>
<span id="cb10-3">plt.plot(diffusion_times, cosine_noises<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cosine Schedule"</span>)</span>
<span id="cb10-4">plt.plot(diffusion_times, offset_noises<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Offset Cosine Schedule"</span>)</span>
<span id="cb10-5"></span>
<span id="cb10-6">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"t / T"</span>)</span>
<span id="cb10-7">plt.ylabel(<span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">r"</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">1-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">\b</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">ar{</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\a</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">lpha_t}</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">$</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;"> </span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">(</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">Noise</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">)</span><span class="vs" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb10-8">plt.legend()</span>
<span id="cb10-9">plt.show()</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-9-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="build-parts-for-model" class="level2">
<h2 class="anchored" data-anchor-id="build-parts-for-model">Build Parts for Model</h2>
<section id="sinusoidal-embedding" class="level3">
<h3 class="anchored" data-anchor-id="sinusoidal-embedding">Sinusoidal Embedding</h3>
<div id="cell-14" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722976779,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:1,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-execution_count="11">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> SinusoidalTimeEmbedding(nn.Module):</span>
<span id="cb11-2">  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># class가 호출되면 -&gt; __init__실행 -&gt; nn.Module(pytorch)의 __init__ 실행</span></span>
<span id="cb11-3">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dim):</span>
<span id="cb11-4">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># super(): 상속받은 부모 클래스인 nn.Module</span></span>
<span id="cb11-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">assert</span> dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"time embedding dim must be even and &gt;= 4"</span></span>
<span id="cb11-6">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># self: SinusoidalTimeEmbedding로 만든 instance</span></span>
<span id="cb11-7"></span>
<span id="cb11-8">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, time):</span>
<span id="cb11-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># input: time - (Batch_Size, ) shape의 1D tensor</span></span>
<span id="cb11-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># output: embeddings - (Batch_Size, dim) shpae의 2D tensor</span></span>
<span id="cb11-11"></span>
<span id="cb11-12">    device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time.device <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time이 있을 공간(CPU or GPU)이 나중에 연산을 할 기준 공간</span></span>
<span id="cb11-13"></span>
<span id="cb11-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># frequency: 1 / 10000^(2i / dim) -&gt; 1 / 10000^(i / half_dim - 1) [0부터 시작하니까]</span></span>
<span id="cb11-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># log 씌워서 계산 (컴퓨터가 계산하기 더 좋다고 함)</span></span>
<span id="cb11-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># - {i / (half_dim - 1)} * log(10000) = -i * {log(10000) / half_dim - 1}</span></span>
<span id="cb11-17"></span>
<span id="cb11-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 1. half_dim 계산</span></span>
<span id="cb11-19">    half_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb11-20"></span>
<span id="cb11-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 2. log(10000) / half_dim - 1</span></span>
<span id="cb11-22">    pre_frequency <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> math.log(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10000</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (half_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-23"></span>
<span id="cb11-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 3. i 만들기</span></span>
<span id="cb11-25">    i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.arange(half_dim, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device)</span>
<span id="cb11-26"></span>
<span id="cb11-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">##4. frequency 완성</span></span>
<span id="cb11-28">    frequency <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pre_frequency)</span>
<span id="cb11-29"></span>
<span id="cb11-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time(Batch_size, )와 frequency(half_dim, ) 텐서 변형해서 행렬곱 -&gt; half_embeddings(Batch_size, half_dim)</span></span>
<span id="cb11-31">    half_embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time[:, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> frequency[<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, :]</span>
<span id="cb11-32"></span>
<span id="cb11-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># half_embeddings에 sin, cos 적용해서 수평으로 붙이기 -&gt; embeddings(Batch_size, dim) 완성</span></span>
<span id="cb11-34">    embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cat((half_embeddings.sin(), half_embeddings.cos()), dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb11-35"></span>
<span id="cb11-36">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> embeddings</span></code></pre></div></div>
</div>
<section id="visualization" class="level4">
<h4 class="anchored" data-anchor-id="visualization">Visualization</h4>
<div id="cell-16" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722977305,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:525,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-outputid="0d6c3433-83b4-4d4a-c5aa-8b3794af0b3a" data-execution_count="12">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># instance</span></span>
<span id="cb12-2">embedding_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb12-3">time_embedder <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> SinusoidalTimeEmbedding(embedding_dim) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># sinusoidal 인스턴스 생성(32차원으로)</span></span>
<span id="cb12-4">times_sample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.arange(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># t = 0 ~ 999</span></span>
<span id="cb12-5">embeddings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time_embedder(times_sample) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time_embedder.forward() 안 해도 forward 호출해준다 (pytorch에 call함수로 잘 설계돼있다)</span></span>
<span id="cb12-6"></span>
<span id="cb12-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot</span></span>
<span id="cb12-8">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb12-9">embedding_matrix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> embeddings.cpu().numpy().T <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># embedding을 transpose -&gt; x축: t, y축: dim</span></span>
<span id="cb12-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># aspect='auto': 픽셀 하나 정사각형 고집 부리지말고 figsize에 맞춰서 꽉 채워라</span></span>
<span id="cb12-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># origin='lower': 수학 그래프 그리듯이 원점을 가장 아래에 둬라</span></span>
<span id="cb12-12">plt.imshow(embedding_matrix, aspect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'auto'</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'coolwarm'</span>, origin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lower'</span>)</span>
<span id="cb12-13">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Sinusoidal Time Embeddings with 1000 Timesteps"</span>)</span>
<span id="cb12-14">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time Step (t)"</span>)</span>
<span id="cb12-15">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Dimension"</span>)</span>
<span id="cb12-16">plt.colorbar(label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Value"</span>)</span>
<span id="cb12-17">plt.show()</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-11-output-1.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="residual-block" class="level3">
<h3 class="anchored" data-anchor-id="residual-block">Residual Block</h3>
<section id="normalization-정리" class="level5">
<h5 class="anchored" data-anchor-id="normalization-정리">Normalization 정리</h5>
<p>(N=64, C=64, H=64, W=64) 기준 - <strong>Batch Norm</strong>: Batch 1 안에서 Channel 1을 끌어모아서 모든 픽셀에 대해 평균, 표준편차 구함 -&gt; Batch 1 안에서 C(채널 개수)개의 평균과 표준편차 나옴 -&gt; N 고정, C고정 - <strong>Layer Norm</strong>: Img 1에서 모든 픽셀에 대해 평균, 표준편차 구함 -&gt; Batch 하나 당 Batch_Size개의 평균과 표준편차 나옴 -&gt; C, H, W 고정 - <strong>Group Norm</strong>: Img 1, Channel 1, 2 에서 모든 픽셀에 대해 평균, 표준편차 구함 -&gt; 보통 사진 하나 당 그룹을 32개로 고정 -&gt; Batch 하나 당 32 * Batch_Size 개의 평균과 표준편차 나옴 -&gt; N, H, W 고정, C 그룹화 고정</p>
<div id="cell-19" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722977309,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:2,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-execution_count="13">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> ResidualBlock(nn.Module):</span>
<span id="cb13-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, input_channels, output_channels, time_emb_dim, groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>): <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># groups: GroupNorm 할 때 그룹개수(32개가 국룰이지만 채널 개수 충분하지 않아서 8로)</span></span>
<span id="cb13-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb13-4"></span>
<span id="cb13-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># part 1</span></span>
<span id="cb13-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## 3x3 convolution layer에 통과시킨다. padding 1로 줘야 projection 의 사이즈가 원래 이미지 사이즈랑 같아짐</span></span>
<span id="cb13-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## poj_size = img_size - conv_size + 1 에서 conv_size = 3 이므로 poj_size = img_size - 2 -&gt; img_size에 2 더해줘야 같아짐</span></span>
<span id="cb13-8">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.proj1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Conv2d(input_channels, output_channels, kernel_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## GroupNorm</span></span>
<span id="cb13-10">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.norm1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.GroupNorm(groups, output_channels)</span>
<span id="cb13-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Activation function: SiLU = x * sigma(x), where sigma(x) = sigmoid</span></span>
<span id="cb13-12">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.act1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.SiLU()</span>
<span id="cb13-13"></span>
<span id="cb13-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time embedding part</span></span>
<span id="cb13-15">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.time_embedding <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Sequential(</span>
<span id="cb13-16">        nn.SiLU(), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time embedding을 SiLU에 통과시켜서 비선형성 부여</span></span>
<span id="cb13-17">        nn.Linear(time_emb_dim, output_channels) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># FFN 통과시켜서 output_channel이랑 time_emb_dim 똑같이 만들어줌</span></span>
<span id="cb13-18">    )</span>
<span id="cb13-19"></span>
<span id="cb13-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># part 2</span></span>
<span id="cb13-21">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.proj2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Conv2d(output_channels, output_channels, kernel_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb13-22">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.norm2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.GroupNorm(groups, output_channels)</span>
<span id="cb13-23">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.act2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.SiLU()</span>
<span id="cb13-24"></span>
<span id="cb13-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># residual connection part</span></span>
<span id="cb13-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## channel 다르면 1x1 convolution으로 맞춰준다</span></span>
<span id="cb13-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> input_channels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> output_channels:</span>
<span id="cb13-28">      <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.connection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Conv2d(input_channels, output_channels, kernel_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (input_channels, 1, 1)인 kernel을 output_channels개 준비해서 convolution</span></span>
<span id="cb13-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb13-30">      <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.connection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Identity() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 그냥 통과(y = x)</span></span>
<span id="cb13-31"></span>
<span id="cb13-32">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x, t):</span>
<span id="cb13-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x(img): (Batch_Size, input_channels, H, W)</span></span>
<span id="cb13-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># t: (Batch_Size, time_emb_dim)</span></span>
<span id="cb13-35">    h_for_connection <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Residual Connection 위해서 저장</span></span>
<span id="cb13-36"></span>
<span id="cb13-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># part 1</span></span>
<span id="cb13-38">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.proj1(x)</span>
<span id="cb13-39">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.norm1(h)</span>
<span id="cb13-40">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.act1(h)</span>
<span id="cb13-41"></span>
<span id="cb13-42">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time embedding adding part</span></span>
<span id="cb13-43">    time_emb <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.time_embedding(t) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time embedding 변환 -&gt; (Batch_Size, output_channels)</span></span>
<span id="cb13-44">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> time_emb[:, :, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>] <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time_emb: (Batch_Size, output_channels) -&gt; (Batch_Size, output_channels, 1, 1) (H, W)가 (1, 1)이 아니어도 같은 값 다 더해짐</span></span>
<span id="cb13-45"></span>
<span id="cb13-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># part 2</span></span>
<span id="cb13-47">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.proj2(h)</span>
<span id="cb13-48">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.norm2(h)</span>
<span id="cb13-49">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.act2(h)</span>
<span id="cb13-50"></span>
<span id="cb13-51">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># residual connection part(return)</span></span>
<span id="cb13-52">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.connection(h_for_connection)</span></code></pre></div></div>
</div>
</section>
</section>
<section id="attention-block" class="level3">
<h3 class="anchored" data-anchor-id="attention-block">Attention Block</h3>
<div id="cell-21" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722977311,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:1,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-execution_count="14">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> AttentionBlock(nn.Module):</span>
<span id="cb14-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, channels, groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>):</span>
<span id="cb14-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb14-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1. Group Norm</span></span>
<span id="cb14-5">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.norm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.GroupNorm(groups, channels)</span>
<span id="cb14-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#2. Q, K, V 만들 1x1 Convolution Layer</span></span>
<span id="cb14-7">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.qkv_layer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Conv2d(channels, channels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, kernel_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb14-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#3. 마무리 projection할 Convolution Layer</span></span>
<span id="cb14-9">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.proj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Conv2d(channels, channels, kernel_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb14-10"></span>
<span id="cb14-11">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x):</span>
<span id="cb14-12">    B, C, H, W <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.shape <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># shape 정보 필요</span></span>
<span id="cb14-13">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># for skip-connection</span></span>
<span id="cb14-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Norm, QKV</span></span>
<span id="cb14-15">    qkv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.qkv_layer(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.norm(h))</span>
<span id="cb14-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (B, 3C, H, W) -&gt; (B, 3C, H*W) -&gt; (B, H*W, 3C)</span></span>
<span id="cb14-17">    qkv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> qkv.reshape(B, C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).permute(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb14-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Query, Key, Value 분해</span></span>
<span id="cb14-19">    q, k, v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> qkv.chunk(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb14-20"></span>
<span id="cb14-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Attention score</span></span>
<span id="cb14-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## softmax(Q * K^T/sqrt(d))</span></span>
<span id="cb14-23">    scale <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(C) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>)</span>
<span id="cb14-24">    attn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.bmm(q, k.transpose(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> scale <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bmm = batch matrix multiplication</span></span>
<span id="cb14-25">    attn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.nn.functional.softmax(attn, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb14-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## softmax(Q * K^T/sqrt(d)) * v</span></span>
<span id="cb14-27">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.bmm(attn, v)</span>
<span id="cb14-28"></span>
<span id="cb14-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 원래 shape으로 복구</span></span>
<span id="cb14-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (B, H*W, C) -&gt; (B, C, H*W) -&gt; (B, C, H, W)</span></span>
<span id="cb14-31">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h.permute(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).reshape(B, C, H, W)</span>
<span id="cb14-32"></span>
<span id="cb14-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># final projection, add(skip-connection)</span></span>
<span id="cb14-34">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.proj(h)</span>
<span id="cb14-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> h</span></code></pre></div></div>
</div>
</section>
<section id="down-block" class="level3">
<h3 class="anchored" data-anchor-id="down-block">Down Block</h3>
<div id="cell-23" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722977313,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:1,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-execution_count="15">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> DownBlock(nn.Module):</span>
<span id="cb15-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, input_channels, output_channels, time_emb_dim, groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>):</span>
<span id="cb15-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb15-4"></span>
<span id="cb15-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># part 1: residual block 2개 쌓기</span></span>
<span id="cb15-6">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.res_block1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ResidualBlock(input_channels, output_channels, time_emb_dim, groups)</span>
<span id="cb15-7">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.res_block2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ResidualBlock(output_channels, output_channels, time_emb_dim, groups)</span>
<span id="cb15-8"></span>
<span id="cb15-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># part 2: Downsampling</span></span>
<span id="cb15-10">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.downsample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Conv2d(output_channels, output_channels, kernel_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 두 칸씩 이동해서 픽셀 수 절반으로 줄임</span></span>
<span id="cb15-11"></span>
<span id="cb15-12">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x, t):</span>
<span id="cb15-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x: B(Batch_size, input_channels, H, W)</span></span>
<span id="cb15-14"></span>
<span id="cb15-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># residual block 두 번 통과</span></span>
<span id="cb15-16">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.res_block1(x, t)</span>
<span id="cb15-17">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.res_block2(x, t)</span>
<span id="cb15-18"></span>
<span id="cb15-19">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># downsampling</span></span>
<span id="cb15-20">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x</span>
<span id="cb15-21">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.downsample(x) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># (Batch_Size, output_channels, H/2, W/2)</span></span>
<span id="cb15-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x, h</span></code></pre></div></div>
</div>
</section>
<section id="up-block" class="level3">
<h3 class="anchored" data-anchor-id="up-block">Up Block</h3>
<div id="cell-25" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722977318,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:4,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-execution_count="16">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> UpBlock(nn.Module):</span>
<span id="cb16-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, input_channels, output_channels, time_emb_dim, groups<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>):</span>
<span id="cb16-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb16-4"></span>
<span id="cb16-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># part1: upsampling</span></span>
<span id="cb16-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## Transposed Convolution: 픽셀 한 칸을 여러 칸으로 흩뿌리기(Convoludtion의 역연산) -&gt; 2배로 커짐</span></span>
<span id="cb16-7">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.upsample <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.ConvTranspose2d(input_channels, output_channels, kernel_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, stride<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2*2 영역에 뿌리기, 새 도화지에서 2칸씩 이동</span></span>
<span id="cb16-8"></span>
<span id="cb16-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># part2: residual block 2개 쌓기</span></span>
<span id="cb16-10">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.res_block1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ResidualBlock(output_channels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, output_channels, time_emb_dim, groups) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Residual connection 한 것과 올라온 x 합칠 것</span></span>
<span id="cb16-11">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.res_block2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ResidualBlock(output_channels, output_channels, time_emb_dim, groups)</span>
<span id="cb16-12"></span>
<span id="cb16-13">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x, residual, t):</span>
<span id="cb16-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x: (Batch_Size, input_channels, H, W) -&gt; down block 거쳐온 이미지</span></span>
<span id="cb16-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># residual: (Batch_Size, output_channels, H*2, W*2) -&gt; Down Block에서 저장해둔 것</span></span>
<span id="cb16-16"></span>
<span id="cb16-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Upsampling(H, W -&gt; 2H, 2W)</span></span>
<span id="cb16-18">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.upsample(x)</span>
<span id="cb16-19"></span>
<span id="cb16-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Concatenation</span></span>
<span id="cb16-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## dim=1 방향: Channel 방향</span></span>
<span id="cb16-22">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">## (B, C, H, W) -&gt; (B, 2C, H, W)</span></span>
<span id="cb16-23">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cat([x, residual], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb16-24"></span>
<span id="cb16-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># ResBlock 통과시키기</span></span>
<span id="cb16-26">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.res_block1(x, t)</span>
<span id="cb16-27">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.res_block2(x, t)</span>
<span id="cb16-28"></span>
<span id="cb16-29">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x</span></code></pre></div></div>
</div>
</section>
<section id="u-net" class="level3">
<h3 class="anchored" data-anchor-id="u-net">U-Net</h3>
<div id="cell-27" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765722977321,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:1,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-execution_count="17">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> UNet(nn.Module):</span>
<span id="cb17-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, channel_in <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, channel_out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, time_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>):</span>
<span id="cb17-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb17-4"></span>
<span id="cb17-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1. Time Embedding</span></span>
<span id="cb17-6">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.time_dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time_dim</span>
<span id="cb17-7">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.time_mlp <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Sequential(</span>
<span id="cb17-8">        SinusoidalTimeEmbedding(time_dim), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time embedding 생성</span></span>
<span id="cb17-9">        nn.Linear(time_dim, time_dim), <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># FFN</span></span>
<span id="cb17-10">        nn.SiLU() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># activation function -&gt; 선형성 깨뜨리기</span></span>
<span id="cb17-11">    )</span>
<span id="cb17-12"></span>
<span id="cb17-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#2. Initial Image Transform(3 Channels -&gt; 64 Channels)</span></span>
<span id="cb17-14">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.conv_init <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Conv2d(channel_in, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, kernel_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb17-15"></span>
<span id="cb17-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#3. Down</span></span>
<span id="cb17-17">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.down1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DownBlock(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, time_dim) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 64 -&gt; 128</span></span>
<span id="cb17-18">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.down2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DownBlock(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, time_dim) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 128 -&gt; 256</span></span>
<span id="cb17-19"></span>
<span id="cb17-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#4. Bottom</span></span>
<span id="cb17-21">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bottom1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ResidualBlock(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, time_dim)</span>
<span id="cb17-22">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.attn_bottom <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> AttentionBlock(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Attention Block</span></span>
<span id="cb17-23">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bottom2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ResidualBlock(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, time_dim)</span>
<span id="cb17-24"></span>
<span id="cb17-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#5. Up</span></span>
<span id="cb17-26">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.up1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UpBlock(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, time_dim)</span>
<span id="cb17-27">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.up2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UpBlock(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, time_dim)</span>
<span id="cb17-28"></span>
<span id="cb17-29">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#6. Output</span></span>
<span id="cb17-30">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.conv_out <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Conv2d(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span>, channel_out, kernel_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb17-31"></span>
<span id="cb17-32">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x, t):</span>
<span id="cb17-33">    t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.time_mlp(t) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># time embedding</span></span>
<span id="cb17-34">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.conv_init(x) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># initial transform</span></span>
<span id="cb17-35">    x, h1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.down1(x, t) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># down, save input</span></span>
<span id="cb17-36">    x, h2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.down2(x, t)</span>
<span id="cb17-37">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bottom1(x, t) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># bottom</span></span>
<span id="cb17-38">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.attn_bottom(x)</span>
<span id="cb17-39">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.bottom2(x, t)</span>
<span id="cb17-40">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.up1(x, h2, t) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># up(skip connection)</span></span>
<span id="cb17-41">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.up2(x, h1, t)</span>
<span id="cb17-42"></span>
<span id="cb17-43">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.conv_out(x)</span></code></pre></div></div>
</div>
</section>
</section>
<section id="build-diffusion-model" class="level2">
<h2 class="anchored" data-anchor-id="build-diffusion-model">Build Diffusion Model</h2>
<div id="cell-29" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1765723957358,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:20,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-execution_count="23">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> DiffusionModel(nn.Module):</span>
<span id="cb18-2">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, network):</span>
<span id="cb18-3">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>().<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb18-4">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.network <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> network <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># U-Net</span></span>
<span id="cb18-5">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># number of timestep</span></span>
<span id="cb18-6">    schedules <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionSchedules(T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.T) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Scheduler instance</span></span>
<span id="cb18-7">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.blur_rates, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.noise_rates <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> schedules.linear_diffusion_schedule() <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># scheduler: linear로 선택</span></span>
<span id="cb18-8"></span>
<span id="cb18-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Buffer로 등록(GPU로 이동)</span></span>
<span id="cb18-10">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.register_buffer(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"blur_rates_buffer"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.blur_rates)</span>
<span id="cb18-11">    <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.register_buffer(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"noise_rates_buffer"</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.noise_rates)</span>
<span id="cb18-12"></span>
<span id="cb18-13">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x_0):</span>
<span id="cb18-14">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x_0: 원본 이미지</span></span>
<span id="cb18-15">    batch_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_0.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb18-16">    device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_0.device <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 마찬가지로 기준 연산공간 지정</span></span>
<span id="cb18-17"></span>
<span id="cb18-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1. random t sampling: (batch_size, )만큼</span></span>
<span id="cb18-19">    t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randint(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.T, (batch_size, ), device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device)</span>
<span id="cb18-20"></span>
<span id="cb18-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#2. 뽑은 t에 대해 blur_rate, noise_rate 준비 -&gt; (batch_size, 1, 1, 1) shape으로</span></span>
<span id="cb18-22">    blur_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.blur_rates_buffer[t].reshape(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb18-23">    noise_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.noise_rates_buffer[t].reshape(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb18-24"></span>
<span id="cb18-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#3. random noise -&gt; label</span></span>
<span id="cb18-26">    noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn_like(x_0) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># x_0랑 같은 모양으로 N(0, 1)에서 sampling</span></span>
<span id="cb18-27"></span>
<span id="cb18-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#4. Forward Process</span></span>
<span id="cb18-29">    img_noisy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> blur_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise_rate <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> noise</span>
<span id="cb18-30"></span>
<span id="cb18-31">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#5. 망가진 이미지, t 주고 U-Net이 Noise 예측</span></span>
<span id="cb18-32">    pred_noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.network(img_noisy, t)</span>
<span id="cb18-33"></span>
<span id="cb18-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#6. Loss</span></span>
<span id="cb18-35">    loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.functional.mse_loss(pred_noise, noise)</span>
<span id="cb18-36"></span>
<span id="cb18-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> loss</span>
<span id="cb18-38"></span>
<span id="cb18-39">  <span class="at" style="color: #657422;
background-color: null;
font-style: inherit;">@torch.no_grad</span>()</span>
<span id="cb18-40">  <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> sample(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, image_size, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, channels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>):</span>
<span id="cb18-41">    device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">next</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.parameters()).device</span>
<span id="cb18-42"></span>
<span id="cb18-43">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 1. 완전한 noise에서 시작</span></span>
<span id="cb18-44">    img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn((batch_size, channels, image_size, image_size), device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device)</span>
<span id="cb18-45"></span>
<span id="cb18-46">    epsilon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-5</span></span>
<span id="cb18-47"></span>
<span id="cb18-48">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 2. T-1 -&gt; 0으로 denoising</span></span>
<span id="cb18-49">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> t <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb18-50">        t_batch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.full((batch_size,), t, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">long</span>)</span>
<span id="cb18-51"></span>
<span id="cb18-52">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Noise prediction</span></span>
<span id="cb18-53">        pred_noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.network(img, t_batch)</span>
<span id="cb18-54"></span>
<span id="cb18-55">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Current timestep의 blur/noise rates</span></span>
<span id="cb18-56">        current_blur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.blur_rates_buffer[t]</span>
<span id="cb18-57">        current_noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.noise_rates_buffer[t]</span>
<span id="cb18-58"></span>
<span id="cb18-59">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Previous timestep의 blur rate</span></span>
<span id="cb18-60">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb18-61">            previous_blur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.blur_rates_buffer[t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb18-62">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb18-63">            previous_blur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device)</span>
<span id="cb18-64"></span>
<span id="cb18-65">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Alpha_bar 계산</span></span>
<span id="cb18-66">        alpha_bar_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> current_blur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb18-67">        alpha_bar_prev <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> previous_blur <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb18-68"></span>
<span id="cb18-69">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Alpha_t 계산</span></span>
<span id="cb18-70">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb18-71">            alpha_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alpha_bar_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.clamp(alpha_bar_prev, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>epsilon)</span>
<span id="cb18-72">            alpha_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alpha_t.clamp(epsilon, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb18-73">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb18-74">            alpha_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device)</span>
<span id="cb18-75"></span>
<span id="cb18-76">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Beta_t 계산</span></span>
<span id="cb18-77">        beta_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha_t).clamp(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb18-78"></span>
<span id="cb18-79">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Mean 계산</span></span>
<span id="cb18-80">        sqrt_one_minus_alpha_bar_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sqrt(torch.clamp(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha_bar_t, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>epsilon))</span>
<span id="cb18-81">        coef <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> beta_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sqrt_one_minus_alpha_bar_t</span>
<span id="cb18-82"></span>
<span id="cb18-83">        sqrt_alpha_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sqrt(torch.clamp(alpha_t, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>epsilon))</span>
<span id="cb18-84">        mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sqrt_alpha_t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> coef <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> pred_noise)</span>
<span id="cb18-85"></span>
<span id="cb18-86">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Variance와 noise 추가</span></span>
<span id="cb18-87">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb18-88">            numerator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> beta_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha_bar_prev)</span>
<span id="cb18-89">            denominator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.clamp(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha_bar_t, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>epsilon)</span>
<span id="cb18-90">            posterior_var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> numerator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> denominator</span>
<span id="cb18-91">            posterior_var <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> posterior_var.clamp(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb18-92"></span>
<span id="cb18-93">            sigma_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sqrt(posterior_var)</span>
<span id="cb18-94">            z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn_like(img)</span>
<span id="cb18-95">            img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> sigma_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z</span>
<span id="cb18-96">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb18-97">            img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mean</span>
<span id="cb18-98"></span>
<span id="cb18-99">    img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> img.clamp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb18-100">    img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.0</span></span>
<span id="cb18-101"></span>
<span id="cb18-102">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> img</span></code></pre></div></div>
</div>
</section>
<section id="train" class="level2">
<h2 class="anchored" data-anchor-id="train">Train</h2>
<div id="cell-31" class="cell" data-quarto-private-1="{&quot;key&quot;:&quot;executionInfo&quot;,&quot;value&quot;:{&quot;status&quot;:&quot;error&quot;,&quot;timestamp&quot;:1765724362976,&quot;user_tz&quot;:-540,&quot;elapsed&quot;:403330,&quot;user&quot;:{&quot;displayName&quot;:&quot;이형석&quot;,&quot;userId&quot;:&quot;10765881790672155751&quot;}}}" data-outputid="99283aa5-8938-4129-ce6d-c903f2520d0a" data-execution_count="24">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#1. Model, Optimizer</span></span>
<span id="cb19-2">device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.device(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cuda"</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> torch.cuda.is_available() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"cpu"</span>)</span>
<span id="cb19-3">unet <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> UNet(channel_in<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, channel_out<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, time_dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span>).to(device)</span>
<span id="cb19-4">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> DiffusionModel(network<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>unet).to(device)</span>
<span id="cb19-5">optimizer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.optim.Adam(model.parameters(), lr<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span>)</span>
<span id="cb19-6"></span>
<span id="cb19-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#2. Folders for saving</span></span>
<span id="cb19-8">OUT_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./output"</span></span>
<span id="cb19-9">CKPT_DIR <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"./checkpoint"</span></span>
<span id="cb19-10">os.makedirs(OUT_DIR, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb19-11">os.makedirs(CKPT_DIR, exist_ok<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb19-12"></span>
<span id="cb19-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#3. Learning Loop</span></span>
<span id="cb19-14">EPOCHS <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span></span>
<span id="cb19-15">NUM_SAMPLE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb19-16">IMG_SIZE <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb19-17">SAMPLE_EVERY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb19-18">SAVE_CKPT_EVERY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 50 epoch마다 체크포인트 저장</span></span>
<span id="cb19-19"></span>
<span id="cb19-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loss 기록용</span></span>
<span id="cb19-21">loss_history <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb19-22"></span>
<span id="cb19-23"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Starting training for </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>EPOCHS<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> epochs..."</span>)</span>
<span id="cb19-24"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Device: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>device<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-25"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Total batches per epoch: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(dataloader)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-26"></span>
<span id="cb19-27"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> epoch <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(EPOCHS):</span>
<span id="cb19-28">    model.train()</span>
<span id="cb19-29">    epoch_loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span></span>
<span id="cb19-30">    num_batches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb19-31"></span>
<span id="cb19-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> images, _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> dataloader:</span>
<span id="cb19-33">        images <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> images.to(device)</span>
<span id="cb19-34"></span>
<span id="cb19-35">        optimizer.zero_grad()</span>
<span id="cb19-36">        loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model(images)</span>
<span id="cb19-37">        loss.backward()</span>
<span id="cb19-38">        optimizer.step()</span>
<span id="cb19-39"></span>
<span id="cb19-40">        epoch_loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> loss.item()</span>
<span id="cb19-41">        num_batches <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb19-42"></span>
<span id="cb19-43">    avg_loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> epoch_loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, num_batches)</span>
<span id="cb19-44">    loss_history.append(avg_loss)</span>
<span id="cb19-45"></span>
<span id="cb19-46">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Progress print</span></span>
<span id="cb19-47">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"[Epoch </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>epoch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:3d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>EPOCHS<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">] avg_loss = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>avg_loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-48"></span>
<span id="cb19-49">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 샘플 이미지 생성 (SAMPLE_EVERY마다)</span></span>
<span id="cb19-50">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (epoch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> SAMPLE_EVERY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">or</span> epoch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb19-51">        model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>()</span>
<span id="cb19-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb19-53">            torch.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb19-54">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> torch.cuda.is_available():</span>
<span id="cb19-55">                torch.cuda.manual_seed_all(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb19-56"></span>
<span id="cb19-57">            samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.sample(image_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>IMG_SIZE, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>NUM_SAMPLE, channels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb19-58">            grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_grid(samples.cpu(), nrow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, pad_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb19-59">            grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid.clamp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-60"></span>
<span id="cb19-61">            save_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>OUT_DIR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/generated_img_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>epoch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:03d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.png"</span></span>
<span id="cb19-62">            save_image(grid, save_path)</span>
<span id="cb19-63"></span>
<span id="cb19-64">            plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb19-65">            plt.imshow(grid.permute(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).numpy())</span>
<span id="cb19-66">            plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb19-67">            plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Generated Images at Epoch </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>epoch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-68">            plt.tight_layout()</span>
<span id="cb19-69">            plt.show()</span>
<span id="cb19-70">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"✓ Saved image: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>save_path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-71"></span>
<span id="cb19-72">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 체크포인트 저장 (SAVE_CKPT_EVERY마다)</span></span>
<span id="cb19-73">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> (epoch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> SAVE_CKPT_EVERY <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>:</span>
<span id="cb19-74">        checkpoint <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb19-75">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'epoch'</span>: epoch <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,</span>
<span id="cb19-76">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'model_state_dict'</span>: model.state_dict(),</span>
<span id="cb19-77">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'optimizer_state_dict'</span>: optimizer.state_dict(),</span>
<span id="cb19-78">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'loss'</span>: avg_loss,</span>
<span id="cb19-79">            <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'loss_history'</span>: loss_history,</span>
<span id="cb19-80">        }</span>
<span id="cb19-81">        ckpt_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>CKPT_DIR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/checkpoint_epoch_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>epoch<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:03d}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">.pt"</span></span>
<span id="cb19-82">        torch.save(checkpoint, ckpt_path)</span>
<span id="cb19-83">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Saved checkpoint: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>ckpt_path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb19-84"></span>
<span id="cb19-85"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span>
<span id="cb19-86"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Training completed!"</span>)</span>
<span id="cb19-87"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"="</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">60</span>)</span>
<span id="cb19-88"></span>
<span id="cb19-89"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 최종 Loss 그래프</span></span>
<span id="cb19-90">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb19-91">plt.plot(loss_history, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb19-92">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Epoch'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb19-93">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Average Loss'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)</span>
<span id="cb19-94">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Training Loss Over Time'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, fontweight<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bold'</span>)</span>
<span id="cb19-95">plt.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>)</span>
<span id="cb19-96">plt.tight_layout()</span>
<span id="cb19-97">plt.savefig(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>OUT_DIR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/loss_curve.png"</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">150</span>)</span>
<span id="cb19-98">plt.show()</span>
<span id="cb19-99"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Saved loss curve: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>OUT_DIR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/loss_curve.png"</span>)</span>
<span id="cb19-100"></span>
<span id="cb19-101"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 최종 샘플 생성</span></span>
<span id="cb19-102"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">Generating final samples..."</span>)</span>
<span id="cb19-103">model.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">eval</span>()</span>
<span id="cb19-104"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">with</span> torch.no_grad():</span>
<span id="cb19-105">    torch.manual_seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb19-106">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> torch.cuda.is_available():</span>
<span id="cb19-107">        torch.cuda.manual_seed_all(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb19-108"></span>
<span id="cb19-109">    samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model.sample(image_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>IMG_SIZE, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">25</span>, channels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb19-110">    grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> make_grid(samples.cpu(), nrow<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, pad_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)</span>
<span id="cb19-111">    grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid.clamp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb19-112"></span>
<span id="cb19-113">    save_path <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>OUT_DIR<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/final_samples.png"</span></span>
<span id="cb19-114">    save_image(grid, save_path)</span>
<span id="cb19-115"></span>
<span id="cb19-116">    plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb19-117">    plt.imshow(grid.permute(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).numpy())</span>
<span id="cb19-118">    plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb19-119">    plt.tight_layout()</span>
<span id="cb19-120">    plt.show()</span>
<span id="cb19-121">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Saved final samples: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>save_path<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Starting training for 25 epochs...
Device: cuda
Total batches per epoch: 127
[Epoch   1/25] avg_loss = 0.171135</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-18-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Saved image: ./output/generated_img_001.png
[Epoch   2/25] avg_loss = 0.069920</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-18-output-4.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Saved image: ./output/generated_img_002.png
[Epoch   3/25] avg_loss = 0.055337</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-18-output-6.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Saved image: ./output/generated_img_003.png
[Epoch   4/25] avg_loss = 0.049606</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-18-output-8.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Saved image: ./output/generated_img_004.png
[Epoch   5/25] avg_loss = 0.046708</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-18-output-10.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Saved image: ./output/generated_img_005.png
[Epoch   6/25] avg_loss = 0.044768</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-18-output-12.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Saved image: ./output/generated_img_006.png
[Epoch   7/25] avg_loss = 0.043179</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-18-output-14.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Saved image: ./output/generated_img_007.png
[Epoch   8/25] avg_loss = 0.041937</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM_files/figure-html/cell-18-output-16.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Saved image: ./output/generated_img_008.png</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">KeyboardInterrupt</span>                         Traceback (most recent call last)
<span class="ansi-green-fg">/tmp/ipython-input-3804794597.py</span> in <span class="ansi-cyan-fg">&lt;cell line: 0&gt;</span><span class="ansi-blue-fg">()</span>
<span class="ansi-green-fg ansi-bold">     30</span>     num_batches <span class="ansi-blue-fg">=</span> <span class="ansi-cyan-fg">0</span>
<span class="ansi-green-fg ansi-bold">     31</span> 
<span class="ansi-green-fg">---&gt; 32</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">for</span> images<span class="ansi-blue-fg">,</span> _ <span class="ansi-green-fg">in</span> dataloader<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">     33</span>         images <span class="ansi-blue-fg">=</span> images<span class="ansi-blue-fg">.</span>to<span class="ansi-blue-fg">(</span>device<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">     34</span> 

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torch/utils/data/dataloader.py</span> in <span class="ansi-cyan-fg">__next__</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    730</span>                 <span class="ansi-red-fg"># TODO(https://github.com/pytorch/pytorch/issues/76750)</span>
<span class="ansi-green-fg ansi-bold">    731</span>                 self<span class="ansi-blue-fg">.</span>_reset<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>  <span class="ansi-red-fg"># type: ignore[call-arg]</span>
<span class="ansi-green-fg">--&gt; 732</span><span class="ansi-red-fg">             </span>data <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_next_data<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">    733</span>             self<span class="ansi-blue-fg">.</span>_num_yielded <span class="ansi-blue-fg">+=</span> <span class="ansi-cyan-fg">1</span>
<span class="ansi-green-fg ansi-bold">    734</span>             if (

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torch/utils/data/dataloader.py</span> in <span class="ansi-cyan-fg">_next_data</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    786</span>     <span class="ansi-green-fg">def</span> _next_data<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">    787</span>         index <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_next_index<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">)</span>  <span class="ansi-red-fg"># may raise StopIteration</span>
<span class="ansi-green-fg">--&gt; 788</span><span class="ansi-red-fg">         </span>data <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>_dataset_fetcher<span class="ansi-blue-fg">.</span>fetch<span class="ansi-blue-fg">(</span>index<span class="ansi-blue-fg">)</span>  <span class="ansi-red-fg"># may raise StopIteration</span>
<span class="ansi-green-fg ansi-bold">    789</span>         <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>_pin_memory<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">    790</span>             data <span class="ansi-blue-fg">=</span> _utils<span class="ansi-blue-fg">.</span>pin_memory<span class="ansi-blue-fg">.</span>pin_memory<span class="ansi-blue-fg">(</span>data<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>_pin_memory_device<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torch/utils/data/_utils/fetch.py</span> in <span class="ansi-cyan-fg">fetch</span><span class="ansi-blue-fg">(self, possibly_batched_index)</span>
<span class="ansi-green-fg ansi-bold">     50</span>                 data <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dataset<span class="ansi-blue-fg">.</span>__getitems__<span class="ansi-blue-fg">(</span>possibly_batched_index<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">     51</span>             <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 52</span><span class="ansi-red-fg">                 </span>data <span class="ansi-blue-fg">=</span> <span class="ansi-blue-fg">[</span>self<span class="ansi-blue-fg">.</span>dataset<span class="ansi-blue-fg">[</span>idx<span class="ansi-blue-fg">]</span> <span class="ansi-green-fg">for</span> idx <span class="ansi-green-fg">in</span> possibly_batched_index<span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg ansi-bold">     53</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">     54</span>             data <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>dataset<span class="ansi-blue-fg">[</span>possibly_batched_index<span class="ansi-blue-fg">]</span>

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torch/utils/data/dataset.py</span> in <span class="ansi-cyan-fg">__getitem__</span><span class="ansi-blue-fg">(self, idx)</span>
<span class="ansi-green-fg ansi-bold">    344</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">    345</span>             sample_idx <span class="ansi-blue-fg">=</span> idx <span class="ansi-blue-fg">-</span> self<span class="ansi-blue-fg">.</span>cumulative_sizes<span class="ansi-blue-fg">[</span>dataset_idx <span class="ansi-blue-fg">-</span> <span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg">--&gt; 346</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>datasets<span class="ansi-blue-fg">[</span>dataset_idx<span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">[</span>sample_idx<span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg ansi-bold">    347</span> 
<span class="ansi-green-fg ansi-bold">    348</span>     <span class="ansi-blue-fg">@</span>property

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torchvision/datasets/flowers102.py</span> in <span class="ansi-cyan-fg">__getitem__</span><span class="ansi-blue-fg">(self, idx)</span>
<span class="ansi-green-fg ansi-bold">     88</span> 
<span class="ansi-green-fg ansi-bold">     89</span>         <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>transform<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 90</span><span class="ansi-red-fg">             </span>image <span class="ansi-blue-fg">=</span> self<span class="ansi-blue-fg">.</span>transform<span class="ansi-blue-fg">(</span>image<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">     91</span> 
<span class="ansi-green-fg ansi-bold">     92</span>         <span class="ansi-green-fg">if</span> self<span class="ansi-blue-fg">.</span>target_transform<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torchvision/transforms/transforms.py</span> in <span class="ansi-cyan-fg">__call__</span><span class="ansi-blue-fg">(self, img)</span>
<span class="ansi-green-fg ansi-bold">     93</span>     <span class="ansi-green-fg">def</span> __call__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">,</span> img<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg ansi-bold">     94</span>         <span class="ansi-green-fg">for</span> t <span class="ansi-green-fg">in</span> self<span class="ansi-blue-fg">.</span>transforms<span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">---&gt; 95</span><span class="ansi-red-fg">             </span>img <span class="ansi-blue-fg">=</span> t<span class="ansi-blue-fg">(</span>img<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">     96</span>         <span class="ansi-green-fg">return</span> img
<span class="ansi-green-fg ansi-bold">     97</span> 

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/module.py</span> in <span class="ansi-cyan-fg">_wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1773</span>             <span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_compiled_call_impl<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>  <span class="ansi-red-fg"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1774</span>         <span class="ansi-green-fg">else</span><span class="ansi-blue-fg">:</span>
<span class="ansi-green-fg">-&gt; 1775</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_call_impl<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">   1776</span> 
<span class="ansi-green-fg ansi-bold">   1777</span>     <span class="ansi-red-fg"># torchrec tests the code consistency with the following code</span>

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torch/nn/modules/module.py</span> in <span class="ansi-cyan-fg">_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1784</span>                 <span class="ansi-green-fg">or</span> _global_backward_pre_hooks <span class="ansi-green-fg">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1785</span>                 or _global_forward_hooks or _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1786</span><span class="ansi-red-fg">             </span><span class="ansi-green-fg">return</span> forward_call<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">*</span>args<span class="ansi-blue-fg">,</span> <span class="ansi-blue-fg">**</span>kwargs<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">   1787</span> 
<span class="ansi-green-fg ansi-bold">   1788</span>         result <span class="ansi-blue-fg">=</span> <span class="ansi-green-fg">None</span>

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torchvision/transforms/transforms.py</span> in <span class="ansi-cyan-fg">forward</span><span class="ansi-blue-fg">(self, img)</span>
<span class="ansi-green-fg ansi-bold">    352</span>             PIL Image <span class="ansi-green-fg">or</span> Tensor<span class="ansi-blue-fg">:</span> Rescaled image<span class="ansi-blue-fg">.</span>
<span class="ansi-green-fg ansi-bold">    353</span>         """
<span class="ansi-green-fg">--&gt; 354</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> F<span class="ansi-blue-fg">.</span>resize<span class="ansi-blue-fg">(</span>img<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>size<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>interpolation<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>max_size<span class="ansi-blue-fg">,</span> self<span class="ansi-blue-fg">.</span>antialias<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">    355</span> 
<span class="ansi-green-fg ansi-bold">    356</span>     <span class="ansi-green-fg">def</span> __repr__<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">)</span> <span class="ansi-blue-fg">-&gt;</span> str<span class="ansi-blue-fg">:</span>

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torchvision/transforms/functional.py</span> in <span class="ansi-cyan-fg">resize</span><span class="ansi-blue-fg">(img, size, interpolation, max_size, antialias)</span>
<span class="ansi-green-fg ansi-bold">    475</span>             warnings<span class="ansi-blue-fg">.</span>warn<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">"Anti-alias option is always applied for PIL Image input. Argument antialias is ignored."</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">    476</span>         pil_interpolation <span class="ansi-blue-fg">=</span> pil_modes_mapping<span class="ansi-blue-fg">[</span>interpolation<span class="ansi-blue-fg">]</span>
<span class="ansi-green-fg">--&gt; 477</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> F_pil<span class="ansi-blue-fg">.</span>resize<span class="ansi-blue-fg">(</span>img<span class="ansi-blue-fg">,</span> size<span class="ansi-blue-fg">=</span>output_size<span class="ansi-blue-fg">,</span> interpolation<span class="ansi-blue-fg">=</span>pil_interpolation<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">    478</span> 
<span class="ansi-green-fg ansi-bold">    479</span>     <span class="ansi-green-fg">return</span> F_t<span class="ansi-blue-fg">.</span>resize<span class="ansi-blue-fg">(</span>img<span class="ansi-blue-fg">,</span> size<span class="ansi-blue-fg">=</span>output_size<span class="ansi-blue-fg">,</span> interpolation<span class="ansi-blue-fg">=</span>interpolation<span class="ansi-blue-fg">.</span>value<span class="ansi-blue-fg">,</span> antialias<span class="ansi-blue-fg">=</span>antialias<span class="ansi-blue-fg">)</span>

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/torchvision/transforms/_functional_pil.py</span> in <span class="ansi-cyan-fg">resize</span><span class="ansi-blue-fg">(img, size, interpolation)</span>
<span class="ansi-green-fg ansi-bold">    251</span>         <span class="ansi-green-fg">raise</span> TypeError<span class="ansi-blue-fg">(</span><span class="ansi-blue-fg">f"Got inappropriate size arg: {size}"</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">    252</span> 
<span class="ansi-green-fg">--&gt; 253</span><span class="ansi-red-fg">     </span><span class="ansi-green-fg">return</span> img<span class="ansi-blue-fg">.</span>resize<span class="ansi-blue-fg">(</span>tuple<span class="ansi-blue-fg">(</span>size<span class="ansi-blue-fg">[</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">:</span><span class="ansi-blue-fg">-</span><span class="ansi-cyan-fg">1</span><span class="ansi-blue-fg">]</span><span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">,</span> interpolation<span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">    254</span> 
<span class="ansi-green-fg ansi-bold">    255</span> 

<span class="ansi-green-fg">/usr/local/lib/python3.12/dist-packages/PIL/Image.py</span> in <span class="ansi-cyan-fg">resize</span><span class="ansi-blue-fg">(self, size, resample, box, reducing_gap)</span>
<span class="ansi-green-fg ansi-bold">   2319</span>                 )
<span class="ansi-green-fg ansi-bold">   2320</span> 
<span class="ansi-green-fg">-&gt; 2321</span><span class="ansi-red-fg">         </span><span class="ansi-green-fg">return</span> self<span class="ansi-blue-fg">.</span>_new<span class="ansi-blue-fg">(</span>self<span class="ansi-blue-fg">.</span>im<span class="ansi-blue-fg">.</span>resize<span class="ansi-blue-fg">(</span>size<span class="ansi-blue-fg">,</span> resample<span class="ansi-blue-fg">,</span> box<span class="ansi-blue-fg">)</span><span class="ansi-blue-fg">)</span>
<span class="ansi-green-fg ansi-bold">   2322</span> 
<span class="ansi-green-fg ansi-bold">   2323</span>     def reduce(

<span class="ansi-red-fg">KeyboardInterrupt</span>: </pre>
</div>
</div>
</div>


</section>

 ]]></description>
  <guid>https://your-website-url.example.com/posts/Oxford_102_Flower_Tiny_DDPM.html</guid>
  <pubDate>Fri, 09 Jan 2026 09:13:24 GMT</pubDate>
</item>
</channel>
</rss>
